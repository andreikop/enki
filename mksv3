#!/usr/bin/env python
"""
Monkey Studio free crossplatform IDE.
Main file processes command line arguments and starts the system.
"""
import sys
import os.path
import traceback
import logging
import logging.handlers

from optparse import OptionParser  # Replace with argparse, when python 2.6 is not supported

import mks.core.defines

class _StartProfiler:
    def __init__(self):
        self._steps = []
        from datetime import datetime
        self._importedDateTime = datetime
        self._startTime = datetime.now()

    def stepDone(self, description):
        self._steps.append((description, self._importedDateTime.now()))

    def printInfo(self):
        prev = self._startTime
        totalMs = 0
        for description, time in self._steps:
            diffMs = (time - prev).microseconds / 1000
            totalMs += diffMs
            prev = time
            print '%s: %d' % (description.ljust(30), diffMs)
        print 'Total                         : %d' % totalMs

def excepthook(excepttype, exceptvalue, tracebackobj):
    """Show exception dialog, write to log
    """
    text = ''.join(traceback.format_exception(excepttype, exceptvalue, tracebackobj)).strip()
    text = unicode(text, 'utf8')
    logging.critical(text)
    
    mailto = '<a href="mailto:hlamer@tut.by?subject=Crash&body=asdf">mailto:hlamer@tut.by</a>'
    
    mboxText =  '<html>' + \
                'Exception occured.<br/>' + \
                'MkS team tries to avoid such problems and make mksv3 stable<br/>' + \
                'To help us <font color="red">send please a bug report to the developers</font><br/>' + \
                mailto + '<br/>' + \
                '<br/>' + \
                'Include your description and this text:<br/>' + \
                '<br/>' + \
                text.replace('\n', '<br/>\n') + \
                '</html>'

    from PyQt4.QtGui import QMessageBox
    QMessageBox.critical(None, 'Oops. Internal exception', mboxText)

def _showErrorMessage(haveQt, header, html, plain):
    """Show error message with messagebox
    """
    print >> sys.stderr, header
    print >> sys.stderr, plain
    if haveQt:
        from PyQt4.QtGui import QApplication, QMessageBox
        app = QApplication ( sys.argv )
        QMessageBox.critical(None, header, html)
    else:
        try:
            import tkMessageBox
        except ImportError:
            return
        tkMessageBox.showwarning(header, plain)

def _checkDependencies():
    """Check if 3rdparty software is installed in the system.
    Notify user, how to install it
    """
    try:
        import PyQt4
    except ImportError, ex:
        plain =  'Failed to import Qt4 python bindings:\n' + \
                 str(ex) + '\n' + \
                 'Install package python-qt4, or download sources from ' \
                 'http://www.riverbankcomputing.co.uk/software/pyqt/download'
        
        _showErrorMessage(False, 'PyQt4 not found', plain, plain)
        raise ex

    import sip
    sip.setapi('QString', 2)

    try:
        import PyQt4.Qsci
    except ImportError, ex:
        html = "<html>Failed to import QScintilla 2 python bindings:<br/>" + \
                str(ex) + '<br/>' + \
                "Install <i>python-qscintilla2</i> package, or download and install sources from " \
                "<a href='http://www.riverbankcomputing.co.uk/software/qscintilla/download'>this site</a></html>"
        plain = "Failed to import QScintilla 2 python bindings:\n" + \
                str(ex) + '\n' + \
                "Install python-qscintilla2 package, or download and install sources from " \
                "http://www.riverbankcomputing.co.uk/software/qscintilla/download"
        _showErrorMessage(True, "QScintilla not found", html, plain)
        raise ex
    
    try:
        import configobj
        import validate
    except ImportError, ex:
        html = "<html>Failed to import ConfigObj modules:<br/>" + \
                str(ex) + '<br/>' + \
                "Download and install it from <i>python-configobj</i> Debian/Ubuntu package or from" \
                "<a href='http://www.voidspace.org.uk/python/configobj.html#downloading'>this site</a></html>"
        plain = "Failed to import ConfigObj modules:" + \
                str(ex) + '\n' + \
                "Download and install it from python-configobj Debian/Ubuntu package or from " \
                "http://www.voidspace.org.uk/python/configobj.html#downloading"
        _showErrorMessage(True, "ConfigObj not found", html, plain)
        raise ex

def _configureLogging():
    logging.basicConfig(level=logging.ERROR)
    fileHandler = logging.handlers.RotatingFileHandler('/tmp/mksv3.log', 'a', 100 * 1024, 1)
    logging.getLogger('').addHandler(fileHandler)

def main():
    parser = OptionParser(usage="%prog [options] [FILE [+LINE_NUMBER_TO_GO] .. [FILE]]]",
                          version="%prog " + mks.core.defines.PACKAGE_VERSION)

    parser.add_option("-p", "--profile", dest="profile", action="store_true",
                      help="profile initialization and exit. For developers")
    (options, args) = parser.parse_args()
    
    if options.profile:
        profiler = _StartProfiler()
    else:
        profiler = None

    try:
        _checkDependencies()
    except ImportError:
        return -1

    # Imports only here. Hack for ability to get help and version info even on system without PyQt.
    import PyQt4.QtGui
    
    if profiler is not None:
        profiler.stepDone('Import modules')
    
    _configureLogging()
    sys.excepthook = excepthook
    
    app = PyQt4.QtGui.QApplication ( sys.argv )
    app.setApplicationName( mks.core.defines.PACKAGE_NAME )
    app.setOrganizationName( mks.core.defines.PACKAGE_ORGANISATION )
    app.setOrganizationDomain( mks.core.defines.PACKAGE_URL )
    app.lastWindowClosed.connect(app.quit)

    if profiler is not None:
        profiler.stepDone('Construct application')

    # init monkey studio core
    from mks.core.core import core
    core.init(profiler)

    # Parse +N spec.
    fistFileLineToGo = None
    indexesToRemove = []
    for index, arg in enumerate(args):
        if arg.startswith('+'):
            try:
                fistFileLineToGo = int(arg[1:])
            except ValueError:
                core.messageToolBar().appendMessage( 'Invalid argument: ' + arg)

            if fistFileLineToGo < 1:
                core.messageToolBar().appendMessage( 'Invalid argument: ' + arg)
                fistFileLineToGo = None
            
            indexesToRemove.append(index)
    for index in indexesToRemove[::-1]:
        args = args[:index] + args[index + 1:]
    
    # Get list of absolute pathes of files to open. List may contain not existing files
    filePathes = [os.path.abspath(arg) for arg in args]
    # convert to unicode for avoid Python <-> Qt interaction problems
    filePathes = [unicode(f, 'utf8') for f in filePathes]

    if filePathes:
        for filePath in filePathes:
            if os.path.exists(filePath):
                if fistFileLineToGo is not None:
                    # -1 to convert from users to internal indexing
                    core.workspace().goTo(filePath, line=fistFileLineToGo - 1)
                    fistFileLineToGo = None
                else:
                    core.workspace().openFile(filePath)
            else:
                core.workspace().createEmptyNotSavedDocument(filePath)
    else:
        if core.workspace().textEditorClass():
            core.workspace().createEmptyNotSavedDocument()

    if profiler is not None:
        profiler.stepDone('Open files')

    if core.workspace().currentDocument():
        core.workspace().currentDocument().setFocus()
    
    core.mainWindow().show()
    
    if profiler is not None:
        profiler.stepDone('Show main window')
    
    # execute application
    if profiler is None:
        result = app.exec_()
    else:
        result = 0

    core.term()

    if profiler is not None:
        profiler.stepDone('Terminate core')

    if profiler is not None:
        profiler.printInfo()

    return result

if __name__ == '__main__':
    sys.exit(main())

